---
sidebar_position: 3
---
import productRecommendations from "/img/automations/automations-by-behaviour/product-recommendations/product-recommendations.png";
import legacyInterface from "/img/automations/automations-by-behaviour/product-recommendations/legacy-interface.png";
import howToAddYml from "/img/automations/automations-by-behaviour/product-recommendations/how-to-add-yml.png";
import ymlUpdate from "/img/automations/automations-by-behaviour/product-recommendations/yml-update.png";
import templateRestrictions from "/img/automations/automations-by-behaviour/product-recommendations/add-restrictions-to-the-template.png";
import segmentId from "/img/automations/automations-by-behaviour/product-recommendations/segment-id.png";

# Как настроить товарные рекомендации в письме

Товарные рекомендации — это дополнительный блок в письме, где отображаются товары с сайта, автоматически подобранные для каждого пользователя на основе его покупок и просмотренных товаров.

<p align="center">
    <img src={productRecommendations} alt="Product recommendations" />
</p>

Важно отметить, что товарные рекомендации будут работать только для тех подписчиков, чью активность мы можем отследить на сайте. Это возможно в двух случаях:
- если подписчик хотя бы один раз перешёл на сайт по ссылке из письма, отправленного через Sendsay,
- если вы передадите нам электронные адреса в отдельном запросе (ниже расскажем, как это сделать).

Настройка автоматизации проходит в шесть шагов:

## 1. Загрузите каталог товаров в Sendsay
:::tip Важно
Если в аккаунте уже настроены автоматизации «Брошенная корзина» или «Брошенный просмотр», этот шаг можно пропустить
:::

### Подготовьте файл со списком товаров
Прежде всего нужно подготовить каталог товаров, чтобы загрузить его в Sendsay и добавлять товары оттуда в рассылку. Для этого нужно создать текстовый файл в формате .yml и добавить туда всю информацию о товарах:
- id,
- наименование,
- стоимость,
- ссылка на фотографию и так далее.

Выглядеть файл будет вот так:
```
<offer id="123" type="vendor.model" available="true" bid="1" group_id="136010368">
  <url>http://www.xxxxxx.ru/xxxx</url>
  <price>1749.0000</price>
  <currencyId>RUR</currencyId>
  <caategoryId>490</categoryId>
  <market_category>Дом и дача/Дом и интерьер/Текстиль Шторы</market_category>
 <picture>http://media.xxxxx.xx/products/641by641/13/60/10/XXXXXXXXXXXXXX.jpg</picture>
  <delivery>true</delivery>
  <local_delivery_cost>0</local_delivery_cost>
  <typePrefix>Шторы, занавески</typePrefix>
  <vendor>La Interieurs</vendor>
  <vendorCode>136010368</vendorCode>
  <model>Занавеска с вышивкои по низу</model>
  <description>- Качество VALEUR SURE. Качественная отделка. Со сборкои 60 мм (3 варианта высоты). 91% полиэстера, 9% льна. Красивая вышивка по низу. Простои уход: стирка при 40°, не нужно гладить. Расстояние от отделки до низа 30 см (для размеров 240 и 260 см). Размер в см.</description>
  <sales_notes>Минимальный заказ 1500 руб</sales_notes>
  <manufacturer_warranty>true</manufacturer_warranty>
  <param name="country_of_origin">Франция</param>
  <param name="Пол">OTHER</param>
  <param name="Возраст">OTHER</param>
  <param name="Цвет">белый</param>
  <param name="Размер" unit="FR">240 x 175 см</param>
</offer>
```
Готовый файл нужно загрузить на общедоступный сервер без логина и пароля.

### Создайте автоматизацию для обновления списка товаров
Чтобы подписчики не получали устаревшие предложения, данные о товарах в Sendsay должны периодически обновляться. Это можно сделать с помощью автоматического импорта, который настраивается [в предыдущей версии интерфейса Sendsay](https://sendsay.ru/account/). В неё можно перейти и в самом аккаунте — для этого нажмите на свой адрес (справа от журнала заданий) и в меню выберите пункт «Предыдущий интерфейс»:

<p align="center">
    <img src={legacyInterface} alt="Legacy interface" />
</p>

В предыдущем интерфейсе нужно создать действие по расписанию:
1. Откройте раздел **Система → Действия по расписанию**.
2. В выпадающем меню вместо «Выпуск по расписанию» выберите пункт «Импорт из YML» и нажмите «Создать».
3. Заполните название действия («Товарные рекомендации») и укажите ссылку на файл.
4. Нажмите «Сохранить и активировать».
5. Дождитесь загрузки данных — данные будут обновляться три раза в сутки (по умолчанию в 7:00, 15:00 и 23:00 по московскому времени).

<p align="center">
    <img src={howToAddYml} alt="How to add YML" />
</p>

## 2. Настройте передачу данных с сайта
:::tip Важно
Если в аккаунте уже настроены автоматизации «Брошенная корзина» или «Брошенный просмотр», этот шаг можно пропустить
:::

Чтобы идентифицировать товары, которые нужно выводить в письме, на страницы сайта нужно добавить специальный скрипт. Он находится в предыдущем интерфейсе — перейдите в раздел **Система → Настройки** и раскройте вкладку **Basket script**.

<p align="center">
    <img src={ymlUpdate} alt="YML update" />
</p>

Скрипт нужно вставить на каждую страницу с товаром — например, если у вас в разделе товаров 20 наименований, скрипт надо добавить на все 20 страниц. Скопируйте его в html-код перед закрывающим тегом `</body>` (на виде страниц это не отразится).

## 3. Напишите в службу поддержки
Напишите нам в чат, что хотите подключить товарные рекомендации. Это нужно, чтобы мы начали собирать статистику по активностям пользователей ваших рассылок — так мы сможем впоследствии рекомендовать подходящие товары.

Статистика собирается во время обычных рассылок. Время сбора данных зависит от размера базы:
- если база большая и активная, хватит всего нескольких рассылок,
- если база небольшая, и за выпуск у вас мало открытий и переходов, сбор статистики может занять несколько недель.

## 4. Создайте сегмент для подписчиков, для которых есть рекомендации по товарам
### 1. Создайте сегмент
1. Зайдите в раздел **Подписчики → Сегменты**.
2. Нажмите на синюю кнопку «Создать сегмент».
3. Введите название и выберите тип контактов «Email».
4. Нажмите «Создать сегмент».
5. Скопируйте id сегмента — он отображается в адресной строке браузера.

<p align="center">
    <img src={segmentId} alt="Segment ID" />
</p>

### 2. Задайте условия сегмента
1. Откройте API-консоль — её иконка находится на боковой панели сайта прямо над справочным центром.
2. Отправьте следующий API-запрос:
```
{
"action": "group.filter.set",
"id": "id сегмента",
"filter": [{
"a": "size(_sndsy_recommends)",
"v": "0",
"op": ">"
}]
}
```

## 5. Создайте шаблон письма
Откройте раздел **Контент** и создайте шаблон рассылки.

[Как создать письмо в блочном редакторе](/docs/email-campaigns/create-your-campaign/drag-and-drop-editor.md)

[Как загрузить HTML-шаблон](/docs/email-campaigns/create-your-campaign/how-to-upload-html-template.md)

С товарными рекомендациями стоит быть аккуратным, чтобы не перенасытить ими пользователя. Поэтому при создании шаблона стоит поставить ограничение — письмо не будет отправляться подписчикам, которые уже получали от вас рассылки за выбранный период. Для этого в блоке **Действия с получателями** поставьте галочку «Подписчики, получившие много писем» и укажите период.

<p align="center">
    <img src={templateRestrictions} alt="Add restrictions to the template" />
</p>

Чтобы вставить таблицу с товарными рекомендациями, добавьте в текст шаблона следующий код:
```
[% external_extra('ссылка на ваш yml-файл','format','yml') %]
<table cellpadding=1 border=1>
[% x = 1 %]
   [% cols = 3 %]
   [% items = 12 %]
    [% FOREACH id IN anketa._sndsy_recommends %]
    [% LAST IF loop.count() == items+1 %]
      [% IF x == 1 %]<tr>[% END %]
          <td width=200>
            <img width="200" src="[% IF yml.$id.picture[0] %][% yml.$id.picture[0] %][% ELSE %][% yml.$id.picture %][% END %]">
            <br>[% yml.$id.model %]
          </td>
       [% IF x == cols %]</tr>[% x = 1 %][% ELSE %][% x = x + 1 %][% END %]
[% END %]
   [% IF x < cols AND x > 1 %]
   [% WHILE x <= cols %]<td></td>[% x = x + 1 %][% END %]
</tr>
[% END %]
</table>
```

По умолчанию в письме отображаются двенадцать товаров (это максимум для одного письма). Если вы хотите показывать меньше рекомендаций, измените значение параметра `items`. Товары в письме будут отображаться в порядке приоритетности: от наиболее подходящих к менее.

## 6. Протестируйте, всё ли работает
1. Отправьте себе тестовое письмо со ссылкой на сайт. Перейдите из письма на сайт, просмотрите несколько товаров и закройте сайт.
2. Данные обрабатываются сутки, поэтому нужно подождать.
3. На следующий день перейдите в предыдущий интерфейс Sendsay и откройте свою карточку подписчика. Если всё настроено правильно, там появится новая сущность `_sndsy_recommends`, где будут храниться id просмотренных товаров.

## 7. Создайте автоматизацию
Перейдите в раздел **Автоматизации → По времени** и нажмите «Создать автоматизацию». Появится окно с выбором типа автоматизации — выберите «Автоматизация рассылки». Затем:
1. В пункте «Письмо для рассылки» выберите шаблон письма с товарными рекомендациями.
2. Выберите сегмент подписчиков, для которых есть рекомендации по товарам.
3. Настройте расписание, когда вы хотите отправлять письмо.
4. Нажмите «Сохранить» (в правом нижнем углу).
5. Нажмите «Активировать» (в правом верхнем углу).

![Create product recommendation automation](/img/automations/automations-by-behaviour/product-recommendations/create-product-recommendation-automation.gif)