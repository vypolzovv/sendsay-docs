---
sidebar_position: 3
sidebar_label: 'Данные из amoCRM в рассылках'
---

import templateAllTransactions from '/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/template-with-all-transactions.png';
import howToSetTrigger from '/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/how-to-set-a-trigger.png';

# Как использовать данные из amoCRM в рассылках

С помощью данных из amoCRM можно сегментировать аудиторию и персонализировать письма: оповещать клиентов об&nbsp;изменениях статуса заказа, автоматизировать допродажи и&nbsp;реактивацию, а&nbsp;также ускорить продвижение клиентов в&nbsp;Цифровой Воронке.

[Интеграция с amoCRM](https://docs.sendsay.ru/integrations/integration-with-amocrm)

Данные из&nbsp;amoCRM подставляются в&nbsp;письма при помощи полей и [языка персонализации PROScript](https://docs.sendsay.ru/proscript). Поля в&nbsp;amoCRM бывают системные — их&nbsp;нельзя изменить или&nbsp;удалить), а&nbsp;также&nbsp;пользовательские, которые можно создать и&nbsp;изменить в&nbsp;любой момент).

Для Сделок по&nbsp;умолчанию доступны следующие системные поля:<br/>

- `created_at` &mdash; дата создания,<br/>
- `updated_at` &mdash; дата изменения,<br/>
- `name` &mdash; название,<br/>
- `sale` &mdash; бюджет.

Для Контактов и&nbsp;Компаний можно использовать системные поля:<br/>

- `created_at` — дата создания, <br/>
- `updated_at` — дата изменения.

Собственные поля нужно создавать вручную, затем передавать их&nbsp;в&nbsp;Sendsay. Как это сделать&nbsp;&mdash; разберём на&nbsp;примере поля статуса Сделки.

## Как настроить передачу статуса Сделки в&nbsp;Sendsay

### 1. Создайте новое поле Сделки

Для этого перейдите в&nbsp;свой аккаунт в&nbsp;amoCRM и&nbsp;выберите в&nbsp;левом меню раздел **Сделки**. Откройте карточку любой Сделки, выберите вкладку «Настроить» и&nbsp;создайте новое поле&nbsp;&mdash; например, **Статус сделки**. Нажмите &laquo;Сохранить&raquo;, а затем в&nbsp;верхней части окна редактирования скопируйте и&nbsp;сохраните числовой&nbsp;ID этого поля.

![How to create a new field](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/how-to-create-a-new-field.gif)

Этот ID&nbsp;&mdash; ключ к&nbsp;текущему полю Сделки. Он&nbsp;понадобится для персонализации и&nbsp;подстановки в&nbsp;шаблон письма данных о&nbsp;cтатусе Cделки&nbsp;&mdash; например, оплачена она или нет.

:::tip Важно
После создания нового поля в&nbsp;amoCRM необходимо подождать 15&nbsp;минут, прежде чем передавать его в&nbsp;Sendsay,&nbsp;&mdash; системе потребуется время на&nbsp;сохранение поля.
:::

Для отправки поля в Sendsay перейдите в&nbsp;раздел **Настройки &rarr; Sendsay**. В&nbsp;выпадающем списке поля Сделки укажите созданное поле:

![How to pass a field to Sendsay](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/how-to-pass-a-field-to-Sendsay.png)

Нажмите &laquo;Сохранить&raquo;.

### 2. Заполните новое поле в&nbsp;других Сделках

Чтобы новое поле автоматически меняло значение переходе Сделки на другой этап воронки, необходимо создать триггер Цифровой Воронки. Для этого в&nbsp;amoCRM перейдите в&nbsp;раздел **Сделки** и&nbsp;нажмите &laquo;Настроить&raquo;.

Создайте триггер на&nbsp;каждом этапе Сделки: нажмите &laquo;Добавить триггер&raquo;, выберите пункт **Изменить поле** и&nbsp;укажите условие **Сразу после перехода или создания в&nbsp;этапе**. Затем выберите созданное поле и&nbsp;пропишите значение, соответствующее текущему этапу Сделки. Например, если вы&nbsp;настраиваете этот триггер для этапа &laquo;Первичный контакт&raquo;, то&nbsp;и&nbsp;значение поля нужно указать такое&nbsp;же.

Отметьте галочкой пункт **Применить триггер ко&nbsp;всем текущим сделкам в&nbsp;статусе**&nbsp;&mdash; чтобы всем Сделкам, которые находятся на&nbsp;этом этапе прямо сейчас, присвоилось соответствующее значение нового поля. Затем нажмите &laquo;Готово&raquo;.

![Trigger conditions](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/trigger-conditions.gif)

Добавьте такой триггер для каждого этапа Сделки, включая этап закрытия реализованной сделки:

![Digital funnel](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/digital-funnel.png)

### 3. Настройте передачу данных Сделки в&nbsp;Sendsay при её&nbsp;переходе на&nbsp;новый этап

Чтобы данные Сделок передавались в&nbsp;Sendsay при переходе на&nbsp;каждый новый этап, необходимо создать соответствующий триггер. Для этого в&nbsp;настройках Цифровой Воронки нажмите &laquo;Добавить триггер&raquo;, с&nbsp;помощью поиска найдите виджет Sendsay и&nbsp;нажмите &laquo;Добавить&raquo;.

В&nbsp;поле **Выполнить** выберите пункт **Сразу после перехода или создания в&nbsp;этапе** и&nbsp;нажмите &laquo;Готово&raquo;:

![Sendsay trigger](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/sendsay-trigger.gif)

Создайте такой триггер для каждого этапа Сделки&nbsp;&mdash; так обновлённые данные отправятся в&nbsp;Sendsay сразу, как только Сделка перейдёт на&nbsp;новый этап. Благодаря этому в&nbsp;Sendsay всегда будет актуальная информация о текущих статусах всех Сделок ваших клиентов.

![Sendsay trigger](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/sendsay-trigger.png)

**Как это работает:** Cделка переходит на новый этап → обновляется значение поля Статус сделки → срабатывает триггер Sendsay → данные контакта и Сделки с обновлённым полем отправляются в Sendsay.

### 4. Импортируйте сделки в&nbsp;Sendsay

В&nbsp;amoCRM перейдите в&nbsp;раздел **Сделки** и&nbsp;выберите отображение списком, затем отфильтруйте нужные вам Сделки для импорта в&nbsp;Sendsay&nbsp;&mdash; чтобы наполнить базу подписчиками, с&nbsp;которыми вы&nbsp;хотите поддерживать общение.

[Как импортировать данные Сделок](https://docs.sendsay.ru/email-campaigns/integrations/integration-with-amocrm/#как-импортировать-данные-сделок)

## Как сегментировать аудиторию на&nbsp;основе данных Сделок

Вы&nbsp;можете создавать сегменты в&nbsp;Sendsay на&nbsp;основе данных Сделок из&nbsp;amoCRM&nbsp;&mdash; и&nbsp;отправлять вручную массовые рассылки по&nbsp;этим сегментам. Например, напомнить о&nbsp;себе тем, кто давно ничего не&nbsp;покупал.

Чтобы отправить такую рассылку, необходимо:

1. [Настроить передачу статуса сделки в&nbsp;Sendsay](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-настроить-передачу-статуса-сделки-в-sendsay),
2. Создать соответствующий сегмент, используя в&nbsp;условиях сегмента анкету **Данные из&nbsp;amoCRM**:

   ![Segment setting](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/segment-setting.gif)

   [Как создать сегмент](https://docs.sendsay.ru/subscribers/lists-and-segments/what-is-segment/#как-создать-сегмент)

3. Вручную отправить массовую рассылку по&nbsp;нужному сегменту.

   [Как отправить массовую email-рассылку](https://docs.sendsay.ru/email-campaigns/create-your-campaign/how-to-send-email-campaign)

Если вы&nbsp;уже подключили интеграцию в&nbsp;настройках аккаунта, то&nbsp;в&nbsp;разделе **Подписчики &rarr; Сегменты** есть 4&nbsp;предустановленных сегмента, которые можно изменять под разные маркетинговые задачи. На&nbsp;их&nbsp;примере рассмотрим несколько сценариев коммуникации с&nbsp;подписчиками.

:::tip Важно
В&nbsp;предустановленных сегментах уже есть поле **Статус**, но&nbsp;вам необходимо создать и&nbsp;подставить вместо него своё поле в&nbsp;условие.

[Как создать поле](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-настроить-передачу-статуса-сделки-в-sendsay)
:::

### Сегмент с&nbsp;данными по&nbsp;давности Сделок

Например, вы&nbsp;хотите напомнить о&nbsp;себе тем подписчикам, которые завершили последнюю сделку 2&nbsp;месяца назад,&nbsp;&mdash; чтобы подтолкнуть их&nbsp;к&nbsp;новой покупке.

В&nbsp;Sendsay есть шаблон сегмента **amo2: нет изменений за&nbsp;2&nbsp;месяца, и&nbsp;есть хотя&nbsp;бы одна завершенная сделка**&nbsp;&mdash; в&nbsp;него войдут подписчики, у&nbsp;которых нет изменений ни&nbsp;по&nbsp;одной Сделке за&nbsp;последние 2&nbsp;месяца, но&nbsp;при этом есть хотя&nbsp;бы одна завершённая Сделка:

![Segment conditions](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/segment-conditions.png)

Как работает этот сегмент:

- система проверяет условие, что у&nbsp;подписчиков нет ни&nbsp;одного изменения ни&nbsp;в&nbsp;одной Сделке за&nbsp;последние 60&nbsp;дней. Если хотя&nbsp;бы в&nbsp;одной Сделке изменились данные за&nbsp;последние 60&nbsp;дней, то&nbsp;такие подписчики уже не&nbsp;попадут в&nbsp;сегмент.
- затем система проверяет подписчиков, подходящих под первое условие, на&nbsp;наличие хотя&nbsp;бы одной завершённой Сделки. Если такие данные есть, подписчики попадут в&nbsp;сегмент.

### Сегмент с&nbsp;данными по&nbsp;сумме заказа

Например, вы&nbsp;хотите отправить рассылку о&nbsp;дорогом товаре, но&nbsp;избежать его навязывания тем подписчикам, кто никогда не&nbsp;приобретал дорогие товары. Тогда рассылку стоит отправить только по&nbsp;тем клиентам, у&nbsp;которых сумма хотя&nbsp;бы одного заказа превышает определённое значение.

Готовый сегмент **amo1: есть сделки с&nbsp;бюджетом более 50&nbsp;000** отбирает тех подписчиков, кто совершал хотя&nbsp;бы одну покупку с&nbsp;бюджетом больше 50&nbsp;000&nbsp;рублей:

![Segment conditions](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/segment-conditions1.png)

Таким образом сегмент отфильтрует тех подписчиков, кто уже оплачивал за&nbsp;один заказ более 50&nbsp;000 рублей&nbsp;&mdash; по&nbsp;нему можно отправить массовую рассылку с&nbsp;предложением нового товара.

### Сегмент с&nbsp;данными текущих Сделок

Если нужно подтолкнуть клиентов к&nbsp;совершению действия, относящегося к&nbsp;конкретным сделкам, можно отправить им&nbsp;рассылку в&nbsp;зависимости от&nbsp;данных этих сделок. Например, выделить в&nbsp;сегмент подписчиков, чьи Сделки находятся в&nbsp;статусе **Ожидается оплата** не&nbsp;более месяца,&nbsp;&mdash; и&nbsp;напомнить им&nbsp;об&nbsp;оплате.

Для этого можно использовать сегмент **amo3: есть сделки в&nbsp;статусе &laquo;Ожидается оплата&raquo;, обновленные менее месяца назад**:

![Segment conditions](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/segment-conditions2.png)

Сюда попадут подписчики, у которых данные Сделок соответствуют условиям:

- если клиент участвует хотя&nbsp;бы в&nbsp;одной Сделке, которая обновилась не&nbsp;более 30&nbsp;дней назад,
- и&nbsp;при этом, если Сделка имеет поле Статус со&nbsp;значением **Ожидается оплата**.

Отправьте по&nbsp;сегменту рассылку с&nbsp;напоминанием оплатить заказ и&nbsp;ссылкой на&nbsp;личный кабинет.

## Как персонализировать рассылку на&nbsp;основе данных Контактов и&nbsp;Компаний

В&nbsp;любую рассылку можно подставить данные Контакта и&nbsp;Компании с&nbsp;помощью команд подстановки [PROScript](https://docs.sendsay.ru/proscript) в&nbsp;следующем виде:

```
[% anketa.amoCRM.contact.idПОЛЯ %]
[% anketa.amoCRM.company.idПОЛЯ %]
```

Чтобы отобразить в&nbsp;письме нужные данные подписчика, вместо `idПОЛЯ` подставьте реальный id&nbsp;поля Контакта или Компании соответственно. Например, `updated_at`, `created_at` или `cf_ID` созданного вручную поля.

О&nbsp;том, как создать поле и&nbsp;найти его&nbsp;ID, [читайте на&nbsp;примере поля **Статус сделки**](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-настроить-передачу-статуса-сделки-в-sendsay).

Например, если поле **Адрес** в&nbsp;amoCRM имеет ID `55555`, то&nbsp;чтобы подписчик увидел свой адрес в&nbsp;письме, пропишите такую команду PROScript:

```
[% anketa.amoCRM.contact.cf_55555 %]
```

## Как персонализировать рассылку на&nbsp;основе данных Сделок

Данные Сделок из&nbsp;amoCRM можно также использовать в&nbsp;рассылках&nbsp;&mdash; например, чтобы каждый клиент мог получить актуальный статус заказа. Для этого:

1. [Настройте передачу статуса сделки в&nbsp;Sendsay](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-настроить-передачу-статуса-сделки-в-sendsay).
2. Создайте нужный сегмент в&nbsp;Sendsay, используя в&nbsp;условиях поля анкеты **Данные из&nbsp;amoCRM**, либо используйте готовый сегмент **amo4: eсть обновления по&nbsp;незавершенным сделкам за&nbsp;последний день**.

   ![Segment conditions](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/segment-conditions3.png)

3. Во&nbsp;вкладке **Настройка условий** нажмите на&nbsp;значок в&nbsp;виде закладки и&nbsp;укажите имя переменной. Например, `leads`.

   ![Variable name](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/variable-name.gif)

   В&nbsp;этой переменной будут храниться данные всех Сделок, подпадающих под условие этого сегмента.

   Например, если в&nbsp;сегмент, который отбирает людей с&nbsp;незавершёнными Сделками, попал подписчик, у&nbsp;которого 7&nbsp;из&nbsp;10&nbsp;Сделок ещё не&nbsp;завершены, то&nbsp;все 7&nbsp;Сделок запишутся в&nbsp;переменную `leads`, а&nbsp;завершённые не&nbsp;запишутся.

4. Создайте шаблон письма, либо выберите готовый **amo2: письмо с&nbsp;данными всех актуальных сделок** в&nbsp;разделе [**Контент**](https://app.sendsay.ru/content/drafts/).

5. Добавьте нужные данные полей для персонализации в&nbsp;письмо с&nbsp;помощью команд подстановки PROScript&nbsp;&mdash; их&nbsp;можно добавлять как в&nbsp;HTML-блок, так и&nbsp;в&nbsp;обычный текстовый блок.

   Разберём команды подстановки на&nbsp;примере шаблона с данными всех актуальных Сделок:

   <p align="center">
     <img width="70%" src={templateAllTransactions} alt="Template with all transactions" />
   </p>

   `[% IF anketa.member.FILTER.leads.size() == 1 %]...[% ELSE %]...[% END %]​​​​​​`​ — это условие, в&nbsp;зависимости от&nbsp;которого подписчики получат письма с&nbsp;разным текстом заголовка: если у&nbsp;клиента всего одна Сделка, удовлетворяющая условиям сегмента, то&nbsp;заголовок в&nbsp;письме будет показываться в&nbsp;единственном числе. Если Сделок несколько&nbsp;&mdash; то&nbsp;во&nbsp;множественном.

   `​​​​​​​[% FOREACH p IN anketa.member.FILTER.leads %]...​​​​​​​[% END %]` — оператор цикла, где `leads` это название переменной, которую мы&nbsp;определили в&nbsp;сегментном редакторе для хранения данных Сделок, подпавших под условия сегмента (см. п. 3).

   Этот оператор цикла последовательно обрабатывает массив Сделок `leads` с&nbsp;множеством данных Сделок тех подписчиков, кто попадает под условия сегмента,&nbsp;&mdash; и&nbsp;выводит в&nbsp;письмо данные по&nbsp;каждой Сделке, сколько&nbsp;бы их&nbsp;ни&nbsp;было. Например, если если сегмент записал в переменную `leads` 3 Сделки в активном статусе с бюджетом более 50&nbsp;000&nbsp;рублей, то все они по очереди отобразятся в письме.

   `​​​​​​​[% lead = datakey(anketa,p) %]` — задаёт переменную `lead`, которая хранит данные каждой конкретной Сделки в&nbsp;каждой итерации цикла (число итераций равно числу подходящих Сделок). С&nbsp;помощью этой переменной можно обращаться к&nbsp;данным полей Сделки&nbsp;&mdash; как к&nbsp;стандартным полям, так и&nbsp;к&nbsp;созданных вручную.

   `​​​​​​​​​​​​​[% lead.name %]` — обращается к&nbsp;имени конкретной Сделки и&nbsp;выводит его в&nbsp;письме.

   `[% lead.sale %]` — выводит в&nbsp;письмо бюджет Сделки.

   `[% lead.cf_1390573 %]` — обращается к&nbsp;созданному в&nbsp;amoCRM полю **Статус сделки** с&nbsp;помощью его числового ID. Здесь и&nbsp;далее вам необходимо заменить эти цифры на&nbsp;[ID вашего поля](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#1-создайте-новое-поле-сделки).

   `[% lead.updated_at %]​​​​[% IF lead.cf_1390573 == 'Ожидается оплата' %]...[% END %]` — персонализация в&nbsp;зависимости от&nbsp;значения поля **Статус сделки**. Если Сделка находится в&nbsp;статусе **Ожидается оплата**, подписчик увидит кнопку со&nbsp;ссылкой на&nbsp;страницу оплаты. Если Сделка имеет другой статус в&nbsp;заданном поле, кнопки не&nbsp;будет.

   [Как персонализировать рассылку](https://docs.sendsay.ru/email-campaigns/personalization/how-to-personalize-campaign)<br/>
   [PROScript](https://docs.sendsay.ru/proscript)

6. Посмотрите, как письмо отображается у&nbsp;того или иного участника Сделки&nbsp;&mdash; для этого на&nbsp;его основе создайте выпуск и&nbsp;укажите заданный сегмент получателей и&nbsp;адрес отправителя. Проверьте отображение письма с&nbsp;данными Сделки при редактировании шаблона, подставив адрес нужного подписчика:

   :::tip Важно
   При отправке [тестовой копии](https://docs.sendsay.ru/email-campaigns/create-your-campaign/how-to-send-email-campaign#4-отправьте-себе-тестовую-копию) данные Сделок не&nbsp;будут правильно отображаться в&nbsp;письме&nbsp;&mdash; чтобы протестировать отображение данных Сделок в&nbsp;разных почтовых клиентах, нужно отправить настоящий выпуск. Убедитесь, что в&nbsp;сегмент попадает исключительно ваш адрес, чтобы рассылка не&nbsp;ушла сразу всем подписчикам.
   :::

7. Отправьте выпуск по&nbsp;заданному сегменту. Если сделок несколько, то&nbsp;подписчик увидит в&nbsp;своём письме каждую из&nbsp;них.

## Как автоматизировать рассылки с&nbsp;данными Сделки

В&nbsp;Sendsay можно настроить:

- автоматическую отправку массовой рассылки с&nbsp;данными всех активных Сделок,
- триггерное письмо с&nbsp;деталями актуального заказа.

Например, когда сделка с&nbsp;полем **Статус сделки** переходит на&nbsp;следующий этап Цифровой Воронки, можно настроить автоматическую отправку писем с&nbsp;деталями заказа.

Разберём настройку автоматизаций на примере этих двух сценариев.

### Как настроить авторассылку с&nbsp;данными всех актуальных Сделок

Например, необходимо отправлять клиентам письма с&nbsp;данными всех активных Сделок&nbsp;&mdash; при условии, что за&nbsp;конкретный промежуток времени изменился статус хотя&nbsp;бы одной из&nbsp;них. Тогда вам нужно создать автоматизацию по&nbsp;времени для сегмента, который отбирает пользователей со&nbsp;Сделками в&nbsp;указанных статусах, которые были недавно обновлены.

Так в&nbsp;шаблон письма подставятся данные всех подходящих под параметры Сделок&nbsp;&mdash; и&nbsp;если данные хотя&nbsp;бы одной Сделки обновились, подписчик получит письмо с&nbsp;данными всех сделок в&nbsp;работе.

Как это сделать:

1. [Настройте передачу статуса сделки в&nbsp;Sendsay](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-настроить-передачу-статуса-сделки-в-sendsay).

2. Создайте сегмент в&nbsp;Sendsay, используя в&nbsp;условиях анкету Данные из&nbsp;amoCRM. Либо воспользуйтесь шаблоном сегмента с&nbsp;данными текущих Сделок **amo4: есть обновления по незавершенным сделкам за последний день**.<br/>

:::tip Важно
При использовании предустановленного сегмента укажите в&nbsp;его условиях своё созданное поле, иначе сегмент не&nbsp;будет работать.
:::

3. Во&nbsp;вкладке **Настройка условий** нажмите на&nbsp;значок в&nbsp;виде закладки и&nbsp;укажите имя переменной — например, `leads`. Нажмите «Сохранить».

   ![Variable name](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/variable-name.png)

4. Перейдите в&nbsp;раздел **Автоматизации &rarr; По&nbsp;времени** и&nbsp;нажмите &laquo;Создать автоматизацию&raquo;, затем выберите тип **Автоматизация рассылки**.

   ![Automation by time](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/automation-by-time.gif)

5. На&nbsp;шаге **Аудитория** нажмите &laquo;Выбрать аудиторию&raquo; и&nbsp;выберите созданный ранее сегмент. Сохраните.

6. На&nbsp;шаге **Письмо** выберите действие **Сделать письмо с&nbsp;нуля**, если хотите самостоятельно создать шаблон, либо используйте готовый шаблон **amo2: письмо с&nbsp;данными всех актуальных сделок**.

   :::tip Важно
   При использовании готового шаблона замените в&nbsp;нём&nbsp;ID поля `cf_1390573`&nbsp;на ID&nbsp;вашего поля статуса, иначе персонализация не&nbsp;будет работать.
   :::

7. Добавьте нужные данные полей для персонализации в&nbsp;письмо с&nbsp;помощью команд подстановки PROScript.

   [Как персонализировать рассылку на основе данных Сделок](https://docs.sendsay.ru/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/#как-персонализировать-рассылку-на-основе-данных-сделок)

   Сохраните результат.

8. На&nbsp;шаге **Расписание** выберите периодичность, с&nbsp;которой должна срабатывать автоматизация. Чтобы подписчики получали актуальную информацию в&nbsp;письме сразу после обновления поля Сделки, вы&nbsp;можете настроить периодичность вплоть до&nbsp;5&nbsp;минут.

   ![Timetable](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/timetable.png)

   [Как создать автоматическую рассылку по расписанию](https://docs.sendsay.ru/automations/automations-by-time/how-to-create-automation-by-time)

   :::tip Важно
   Отправка рассылки зависит не&nbsp;только от&nbsp;расписания автоматизации, но&nbsp;и&nbsp;от&nbsp;условий сегментации. Подписчик не&nbsp;получит письмо, если в&nbsp;момент выпуска по&nbsp;расписанию он&nbsp;не&nbsp;будет находиться в&nbsp;сегменте из-за того, что у&nbsp;него нет ни&nbsp;одной Сделки, которая соответствует выбранным условиям сегмента.<br/><br/> Например, если периодичность&nbsp;&mdash; 15&nbsp;минут, но&nbsp;в&nbsp;сегмент попадают только Сделки, которые были обновлены за&nbsp;последние 5&nbsp;минут, тогда подписчики, у&nbsp;которых Сделки обновились 6-15 минут назад, письмо не&nbsp;получат. Периодичность должна быть равна времени, указанному в сегменте.
   :::

9. При необходимости задайте **Дополнительные настройки** и&nbsp;активируйте автоматизацию. Вот пример персонализации, которую увидит подписчик в письме:

   ![Email example](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/email-example.png)

### Как настроить авторассылку об&nbsp;изменении статуса Сделки

При переходе Сделки на&nbsp;другой этап клиенту можно отправлять автоматическое письмо с&nbsp;актуальными на&nbsp;текущий момент деталями заказа. Например, уведомление об изменении статуса заказа.

В&nbsp;таком случае необходимо создать сценарий с&nbsp;отправкой письма по&nbsp;шаблону, где указана специальная команда персонализации, которая подставляет в&nbsp;письмо данные Сделки.

Как это сделать:

1. В&nbsp;Sendsay перейдите в&nbsp;раздел **Автоматизации &rarr; Сценарии** и&nbsp;нажмите &laquo;Создать сценарий&raquo;.

   [Что такое сценарий и&nbsp;как его создать](https://docs.sendsay.ru/automations/automation-with-workflows/workflow-creation)

2. Нажмите &laquo;Редактировать&raquo; и&nbsp;создайте короткий сценарий из&nbsp;одного шага. В&nbsp;качестве [Стартового события](https://docs.sendsay.ru/automations/automation-with-workflows/workflow-blocks#стартовые-события) выберите **Без стартового события**, следующим шагом&nbsp;&mdash; действие **Отправить подписчику email**. В&nbsp;качестве шаблона выберите **amo1: письмо с&nbsp;данными последней измененной сделки**, либо создайте новый шаблон.

   ![Workflow](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/workflow.png)

3. При создании своего шаблона письма, добавьте в&nbsp;него нужные команды персонализации PROScript для подстановки данных Сделки в&nbsp;письмо&nbsp;&mdash; команды можно скопировать из&nbsp;готового шаблона **amo1: письмо с&nbsp;данными последней измененной сделки**.

   ![Personalization commands](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/email-example3.png)

   Разберем команды персонализации из&nbsp;готового шаблона:

   ```
   [% lead = "" %]
   [% max_updated_at = '1970-01-01 00:00:00' %]
   [% FOREACH n in anketa.amoCRM.leads.values() %]
   [% IF (format_datetime_duration(n.updated_at,max_updated_at,"format",['']) > 0) %]
   [% lead = n %]
   [% max_updated_at = n.updated_at %]
   [% END %]
   [% END %]
   ```

   Этот код выбирает самую позднюю дату обновления среди всех Сделок, в&nbsp;которых участвует подписчик. Затем вы&nbsp;можете обращаться к&nbsp;переменной `lead` для доступа к&nbsp;полям Сделки с самой поздней датой изменения. Например:

   `[% lead.updated_at %]​​​​` — обращается к имени конкретной Сделки и выводит его в письме.

   `[% IF lead.cf_1390573 == 'Ожидается оплата' %]...[% END %]` — персонализация текста в&nbsp;зависимости от&nbsp;поля Статус. Если Сделка находится в&nbsp;статусе **Ожидается оплата**, подписчик увидит кнопку со&nbsp;ссылкой на&nbsp;страницу оплаты. Если&nbsp;же Сделка имеет другой статус в&nbsp;заданном поле, кнопки не&nbsp;будет.

   Если используете предустановленный шаблон, замените в&nbsp;командах PROScript ID&nbsp;поля `cf_1390573`&nbsp;на ID&nbsp;вашего поля, иначе персонализация не&nbsp;будет работать.

   :::tip Важно
   Чтобы протестировать отображение письма, добавьте подтвержденный адрес отправителя.
   :::

   Когда шаблон письма готов, сохраните результат. Вот пример персонализации, которую увидит подписчик в письме:

   ![Email example](/img/email-campaigns/personalization/how-to-use-amocrm-data-in-campaigns/email-example2.png)

   Также можно персонализировать тему письма, чтобы получатели сразу понимали его суть. В&nbsp;предустановленном шаблоне уже указана персонализация темы в&nbsp;зависимости от&nbsp;статуса Сделки:

   ```
   [% anketa.base.firstName %]
   ```

   — имя подписчика.

   ```
   [% lead = "" %]
   [% max_updated_at = '1970-01-01 00:00:00' %]
   [% FOREACH n in anketa.amoCRM.leads.values() %]
   [% IF (format_datetime_duration(n.updated_at,max_updated_at,"format",['']) > 0) %]
   [% lead = n %]
   [% max_updated_at = n.updated_at %]
   [% END %]
   [% END %]
   ```

   — тот же код, который указан в шаблоне. Далее поле Статус будет использоваться в теме. **Не забудьте изменить ID поля Статус.**

   ```
   ​​​​​​​[% IF lead.cf_1390573 == 'Ожидается оплата' %]ваш заказ ожидает оплату
   [% ELSIF lead.cf_1390573 == 'Отправлен!' %]ваш заказ отправлен!
   [% ELSIF lead.cf_1390573 == 'Отменён' %]ваш заказ отменён
   [% ELSIF lead.cf_1390573 == 'Доставлен' %]ваш заказ доставлен[% END %]​​​​​​​
   ```

   — персонализация по Статусу оплаты в теме письма.

4. Перейдите в&nbsp;свой аккаунт в&nbsp;amoCRM, откройте раздел **Сделки** и&nbsp;нажмите &laquo;Настроить&raquo;.

5. Выберите нужный этап Сделки, после перехода на&nbsp;который необходимо отправить письмо,&nbsp;&mdash; и&nbsp;нажмите &laquo;Добавить триггер&raquo;. С&nbsp;помощью поиска найдите виджет Sendsay и&nbsp;нажмите &laquo;Добавить&raquo;.

   В&nbsp;поле **Выполнить** выберите **Сразу после перехода или создания в&nbsp;этапе**, а&nbsp;среди действий&nbsp;&mdash; **Добавить на&nbsp;сценарий рассылки** и&nbsp;выберите созданный ранее сценарий:

   <p align="center">
     <img width="60%" src={howToSetTrigger} alt="How to set a trigger" />
   </p>

   При необходимости отметьте галочкой нужные параметры:

   - применить к&nbsp;основному контакту,
   - применить к&nbsp;дополнительным контактам,
   - применить к&nbsp;компании,
   - применить триггер к&nbsp;текущим сделкам в&nbsp;статусе.

   Нажмите &laquo;Готово&raquo;.

6. Вернитесь в&nbsp;Sendsay на&nbsp;страницу созданного сценария и&nbsp;активируйте сценарий, предварительно включив возможность повторного прохождения&nbsp;&mdash; это необходимо, чтобы рассылка отправлялась каждый раз при обновлении статуса Сделки.
